<div class="account-settings-layout">
  <app-sidebar></app-sidebar>
  <div class="account-settings-container">
  <!-- Header with Tabs -->
  <div class="header">
    <div class="tabs">
      <button 
        class="tab" 
        [class.active]="activeTab === 'account'"
        (click)="setActiveTab('account')">
        Account Settings
      </button>
      <button 
        class="tab" 
        [class.active]="activeTab === 'privacy'"
        (click)="setActiveTab('privacy')">
        Privacy & Security settings
      </button>
    </div>
  </div>

  <!-- Content Area -->
  <div class="content">
    <!-- Account Settings Tab -->
    <div *ngIf="activeTab === 'account'" class="tab-content">
      <div *ngIf="isLoadingUserData" class="loading-message">
        <p>Loading user data...</p>
      </div>
      <div *ngIf="!isLoadingUserData" class="account-form-container">
        <!-- Profile Photo Section -->
        <div class="profile-photo-section">
          <label class="profile-photo-label">Profile photo</label>
        <div class="profile-photo-container">
          <img 
            [src]="profilePhotoPreview || userData.profilePhoto || 'assets/images/image1.png'" 
            alt="Profile Photo" 
            class="profile-photo"
            (error)="onImageError($event)"
            (load)="onImageLoad($event)">
            <div class="photo-buttons">
              <button class="upload-button" (click)="onUploadPhoto()">Upload</button>
              <button 
                *ngIf="profilePhotoPreview || userData.profilePhoto" 
                class="remove-button" 
                (click)="removeProfilePhoto()">Remove</button>
            </div>
          </div>
        </div>

        <!-- Form Fields Section -->
        <div class="form-fields-section">
          <div class="form-field">
            <label class="field-label" for="name">Name*:</label>
            <div class="input-container">
              <input type="text" id="name" class="form-input" [(ngModel)]="userData.name" placeholder="Enter your name" title="Enter your name">
              <button class="clear-button" (click)="clearField('name')" title="Clear name">×</button>
            </div>
          </div>

          <div class="form-field">
            <label class="field-label required" for="email">Email*:</label>
            <div class="input-container">
              <input type="email" id="email" class="form-input readonly-input" [value]="userData.email" readonly title="Email cannot be changed">
            </div>
          </div>

          <div class="form-field">
            <label class="field-label" for="password">Password*:</label>
            <div class="input-container">
              <input 
                [type]="showPassword ? 'text' : 'password'" 
                id="password" 
                class="form-input" 
                [value]="showPassword ? actualPassword : '************'" 
                placeholder="************" 
                title="Click to change password" 
                (click)="onPasswordClick()" 
                readonly>
              <button class="password-toggle-button" (click)="togglePasswordVisibility()" title="Toggle password visibility">
                <span *ngIf="!showPassword">Show</span>
                <span *ngIf="showPassword">Hide</span>
              </button>
              <button class="clear-button" (click)="onPasswordReset()" title="Reset password">×</button>
            </div>
          </div>

          <div class="form-field">
            <label class="field-label" for="household-size">Household Size:</label>
            <div class="input-container">
              <select id="household-size" class="form-input select-input" [(ngModel)]="userData.householdSize" title="Select household size">
                <option value="No-Selection">No Selection</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5" selected>5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10+">10+</option>
              </select>
            </div>
          </div>

          <div class="form-field">
            <label class="field-label" for="date-of-birth">Date of Birth*:</label>
            <div class="input-container">
              <input type="date" id="date-of-birth" class="form-input" [(ngModel)]="userData.dateOfBirth" title="Enter your date of birth">
              <button class="clear-button" (click)="clearField('dateOfBirth')" title="Clear date of birth">×</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Action Buttons - Only show for Account Settings tab -->
    <div *ngIf="activeTab === 'account'" class="action-buttons">
      <button class="cancel-button" (click)="onCancel()" [disabled]="isSaving">Cancel</button>
      <button class="save-button" (click)="onSave()" [disabled]="isSaving">
        <span *ngIf="!isSaving">Save</span>
        <span *ngIf="isSaving">Saving...</span>
      </button>
    </div>

    <!-- Password Reset Confirmation Dialog -->
    <div *ngIf="showPasswordResetDialog" class="dialog-overlay">
      <div class="dialog-container">
        <div class="dialog-content">
          <h3>Do you want to reset your password?</h3>
          <div class="dialog-buttons">
            <button class="dialog-button cancel-dialog-button" (click)="onPasswordResetCancel()">No</button>
            <button class="dialog-button confirm-dialog-button" (click)="onPasswordResetConfirm()">Yes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Password Change Form -->
    <div *ngIf="showPasswordChangeForm" class="dialog-overlay">
      <div class="password-change-container">
        <div class="password-change-content">
          <h2 class="password-change-title">Set a new password</h2>
          <div class="password-form">
            <div class="form-field">
              <label class="field-label" for="new-password">Password*:</label>
              <div class="input-container">
                <input 
                  [type]="showNewPassword ? 'text' : 'password'" 
                  id="new-password" 
                  class="form-input" 
                  [(ngModel)]="newPassword" 
                  placeholder="Enter new password" 
                  title="Enter new password">
                <button class="password-toggle-button" (click)="toggleNewPasswordVisibility()" title="Toggle password visibility">
                  <span *ngIf="!showNewPassword">Show</span>
                  <span *ngIf="showNewPassword">Hide</span>
                </button>
                <button class="clear-button" (click)="clearNewPassword()" title="Clear password">×</button>
              </div>
            </div>
            <div class="form-field">
              <label class="field-label" for="confirm-password">Confirm Password*:</label>
              <div class="input-container">
                <input 
                  [type]="showConfirmPassword ? 'text' : 'password'" 
                  id="confirm-password" 
                  class="form-input" 
                  [(ngModel)]="confirmPassword" 
                  placeholder="Confirm new password" 
                  title="Confirm new password">
                <button class="password-toggle-button" (click)="toggleConfirmPasswordVisibility()" title="Toggle password visibility">
                  <span *ngIf="!showConfirmPassword">Show</span>
                  <span *ngIf="showConfirmPassword">Hide</span>
                </button>
                <button class="clear-button" (click)="clearConfirmPassword()" title="Clear confirm password">×</button>
              </div>
            </div>
          </div>
          <div class="password-change-buttons">
            <button class="cancel-password-button" (click)="onPasswordChangeCancel()">Cancel</button>
            <button class="change-button" (click)="onPasswordChange()">Change</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Privacy & Security Settings Tab -->
    <div *ngIf="activeTab === 'privacy'" class="tab-content">
      <!-- 2FA Verification Form -->
      <div *ngIf="showVerificationForm" class="verification-form-container">
        <div class="verification-form">
          <h2 class="verification-title">Two-Factor Authentication Setup</h2>
          <p class="verification-instructions">Enter the 6-digit verification code sent to your email address.</p>
          
          <div class="verification-input-group">
            <label for="verification-code">Verification Code:</label>
            <input 
              type="text" 
              id="verification-code" 
              [(ngModel)]="verificationCode" 
              name="verificationCode"
              placeholder="Enter 6-digit code"
              maxlength="6"
              pattern="[0-9]{6}"
              class="verification-input">
          </div>
          
          <div class="verification-buttons">
            <button type="button" class="cancel-verification-btn" (click)="onCancelVerification()">Cancel</button>
            <button type="button" class="verify-code-btn" (click)="onVerifyCode()" [disabled]="isVerifyingCode">
              <span *ngIf="!isVerifyingCode">Verify Code</span>
              <span *ngIf="isVerifyingCode">Verifying...</span>
            </button>
          </div>
          
          <div *ngIf="verificationMessage" class="verification-message" [class.success]="verificationSuccess" [class.error]="!verificationSuccess">
            {{ verificationMessage }}
          </div>
        </div>
      </div>

      <!-- Email Link Access Message -->
      <div *ngIf="showEmailLinkMessage" class="email-link-message">
        <div class="email-link-content">
          <h3>🔐 Two-Factor Authentication Setup</h3>
          <p>You've accessed this page via the email link. To complete your 2FA setup, please log in first.</p>
          <div class="email-link-actions">
            <button class="login-btn" (click)="goToLogin()">Go to Login</button>
            <button class="dismiss-btn" (click)="dismissEmailMessage()">Dismiss</button>
          </div>
        </div>
      </div>

      <div class="settings-card">
        <div class="setting-item">
          <span class="setting-label">Two-Factor Authentication</span>
          <div class="toggle-switch">
            <input type="checkbox" id="two-factor-auth" class="toggle-input" 
                   [ngModel]="twoFactorEnabled" 
                   (click)="onTwoFactorToggleClick($event)">
            <label for="two-factor-auth" class="toggle-label">
              <span class="toggle-slider"></span>
              <span class="toggle-text">{{ twoFactorEnabled ? 'ON' : 'OFF' }}</span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Two-Factor Authentication Confirmation Dialog -->
  <div *ngIf="showTwoFactorDialog && !isWaitingForVerification" class="dialog-overlay">
    <div class="dialog-container">
      <div class="dialog-content">
        <h3>Are you sure to switch on Two-Factor Authentication?</h3>
        <div class="dialog-buttons">
          <button class="dialog-button cancel-dialog-button" (click)="onTwoFactorCancel()">Cancel</button>
          <button class="dialog-button confirm-dialog-button" (click)="onTwoFactorConfirm()">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Verification Waiting Dialog -->
  <div *ngIf="showTwoFactorDialog && isWaitingForVerification && !isVerificationCompleted" class="dialog-overlay">
    <div class="dialog-container">
      <div class="dialog-content">
        <div class="waiting-icon">⏳</div>
        <h3>Your account is currently verifying to enable use of 2FA</h3>
        <p class="waiting-message">Please check your email and complete the verification process in the new tab.</p>
        <div class="dialog-buttons">
          <button class="dialog-button cancel-dialog-button" (click)="onCancelVerificationWaiting()">Cancel</button>
          <button class="dialog-button resend-dialog-button" (click)="onResendVerificationLink()">Resend Link</button>
        </div>
      </div>
    </div>
  </div>
  </div>


  <!-- Two-Factor Authentication Disable Confirmation Dialog -->
  <div *ngIf="showTwoFactorDisableDialog" class="dialog-overlay">
    <div class="dialog-container">
      <div class="dialog-content">
        <h3>Are you sure to switch off Two-Factor Authentication?</h3>
        <div class="dialog-buttons">
          <button class="dialog-button cancel-dialog-button" (click)="onTwoFactorDisableCancel()">Cancel</button>
          <button class="dialog-button confirm-dialog-button" (click)="onTwoFactorDisableConfirm()">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Message Modal -->
  <div *ngIf="showSuccessMessage" class="success-overlay">
    <div class="success-container">
      <div class="success-content">
        <div class="success-icon">✓</div>
        <h3 class="success-title">Success!</h3>
        <p class="success-message">{{ successMessage }}</p>
        <div class="success-buttons">
          <button class="success-btn" (click)="onSuccessClose()">OK</button>
        </div>
      </div>
    </div>
  </div>
</div>
