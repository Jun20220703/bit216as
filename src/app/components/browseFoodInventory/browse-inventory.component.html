<div class="layout">
  <!-- Sidebar -->
  <app-sidebar></app-sidebar>

  <!-- Main content -->
  <div class="content">
    <!-- Header -->
    <header class="inventory-header">
      <div class="inventory-title">
        <label>{{ viewTitle }}</label>
        <div class="select-wrapper">
          <!-- 🔹 下拉列表现在根据数据库动态显示 Storage -->
          <select [(ngModel)]="selectedLocation" (ngModelChange)="refreshView()">
            <option value="All">All</option>
            <!-- 🔹 使用 availableLocations (动态生成) -->
            <option *ngFor="let loc of availableLocations" [value]="loc">{{ loc }}</option>
          </select>
          <span class="custom-arrow">▼</span>
        </div>
      </div>

      <div class="header-icons">
        <i class="fa-solid fa-magnifying-glass header-icon" (click)="toggleSearchBar()"></i>
        <i class="fa-solid fa-sliders header-icon" (click)="toggleFilterPanel()"></i>
      </div>
    </header>

    <!-- Search bar -->
    <div *ngIf="showSearch" class="search-bar">
      <input type="text"
             [(ngModel)]="searchQuery"
             (ngModelChange)="refreshView()"
             placeholder="Search food items..." />
    </div>

    <!-- Filter Drawer -->
    <div class="filter-drawer" [class.open]="showFilter">
      <div class="filter-header">
        <h2>Filters</h2>
        <button class="close-btn" (click)="toggleFilterPanel()">×</button>
      </div>

      <div class="filter-section">
        <h3>Source</h3>
        <label>
          <!-- 🔹 使用双向绑定 selectedSource -->
          <input type="radio" name="source" value="inventory"
                [(ngModel)]="selectedSource"
                (ngModelChange)="toggleSource($event)" />
          Inventory only
        </label>
        <label>
          <input type="radio" name="source" value="donation"
                [(ngModel)]="selectedSource"
                (ngModelChange)="toggleSource($event)" />
          Donation List
        </label>
      </div>

      <div class="filter-section">
        <h3>Category</h3>
        <label>
          <input type="checkbox"
                [checked]="filter.categories.all"
                (change)="toggleCategory('all')" />
          All
        </label>

        <!-- 🔹 使用 availableCategories (动态生成) -->
        <label *ngFor="let cat of availableCategories">
          <input type="checkbox"
                [checked]="filter.categories[cat.key]"
                (change)="toggleCategory(cat.key)" />
          {{ cat.name }}
        </label>
      </div>

      <!-- Expired in -->
      <div class="filter-section">
        <h3>Expired in</h3>
        <input type="number" [(ngModel)]="filter.expiredIn" (ngModelChange)="refreshView()" />
        <span> day(s)</span>
      </div>
    </div>

    <!-- 🔹 动态渲染数据库中的 Storage → Category → Item -->
    <div *ngFor="let loc of viewLocs" class="location-block">
      <h1 *ngIf="selectedLocation === 'All'" class="location-title">{{ loc.name }}</h1>

      <div *ngFor="let category of loc.categories" class="category" [ngClass]="category.colorClass">
        <h2>{{ category.icon }} {{ category.name }}</h2>

        <div *ngFor="let item of category.items"
             class="item"
             (mouseenter)="hoverItem = item"
             (mouseleave)="hoverItem = null">

          <!-- 左：名称 + Remaining -->
          <div class="item-name">
            {{ item.name }}
            <span class="remaining">[ Remaining: {{ item.remaining }} ]</span>
          </div>

          <!-- 中：数量选择 -->
          <div class="quantity-slot">
            <div class="quantity-control">
              <button type="button" (click)="decreaseSelected(item)">-</button>
              <span class="qty">{{ item.selectedQty }}</span>
              <button type="button" (click)="increaseSelected(item)">+</button>
            </div>
          </div>

          <!-- 右：操作按钮 -->
          <!-- 🔹 如果是 Inventory，显示 Used/Meal/Donate -->
          <div class="hover-slot" *ngIf="selectedSource === 'inventory'">
            <div class="hover-actions" [class.visible]="hoverItem === item">
              <button class="used" (click)="openConfirm(item, 'used')">Used</button>
              <button class="meal" (click)="openConfirm(item, 'meal')">Meal</button>
              <button class="donate" (click)="openConfirm(item, 'donate')">Donate</button>
            </div>
          </div>

          <!-- 🔹 如果是 Donation，显示 Edit 按钮 -->
          <div class="edit-slot" *ngIf="selectedSource === 'donation'">
            <button class="edit-btn">Edit</button>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- 确认弹窗 -->
<div class="modal-overlay" *ngIf="showConfirm && confirmAction" (click)="closeConfirm()">
  <div class="modal"
       [ngClass]="{
         'modal-used': confirmAction === 'used',
         'modal-meal': confirmAction === 'meal',
         'modal-donate': confirmAction === 'donate'
       }"
       (click)="$event.stopPropagation()">
    <h2>
      Do you want to mark {{ confirmItem?.selectedQty }}
      {{ confirmItem?.name }}(s) as {{ confirmAction }}?
    </h2>
    <div class="modal-buttons">
      <button class="cancel-btn" (click)="closeConfirm()">Cancel</button>
      <button class="action-btn"
              [ngClass]="{
                'btn-used': confirmAction === 'used',
                'btn-meal': confirmAction === 'meal',
                'btn-donate': confirmAction === 'donate'
              }"
              (click)="confirmActionProceed()">
        {{ confirmAction | titlecase }}
      </button>
    </div>
  </div>
</div>
