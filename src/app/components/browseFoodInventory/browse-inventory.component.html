<div class="layout">
  <!-- Sidebar -->
  <app-sidebar></app-sidebar>

  <!-- Main content -->
  <div class="content">
    <!-- Header -->
    <header class="inventory-header">
      <div class="inventory-title">
        <label>{{ viewTitle }}</label>
        <div class="select-wrapper">
          <!-- 🔹 下拉列表：动态 Storage -->
          <select [(ngModel)]="selectedLocation" (ngModelChange)="refreshView()">
            <option value="All">All</option>
            <option *ngFor="let loc of availableLocations" [value]="loc">{{ loc }}</option>
          </select>
          <span class="custom-arrow">▼</span>
        </div>
      </div>

      <div class="header-icons">
        <i class="fa-solid fa-magnifying-glass header-icon" (click)="toggleSearchBar()"></i>
        <i class="fa-solid fa-sliders header-icon" (click)="toggleFilterPanel()"></i>
      </div>
    </header>

    <!-- Search bar -->
    <div *ngIf="showSearch" class="search-bar">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (ngModelChange)="refreshView()"
        placeholder="Search food items..." />
    </div>

    <!-- Filter Drawer -->
    <div class="filter-drawer" [class.open]="showFilter">
      <div class="filter-header">
        <h2>Filters</h2>
        <button class="close-btn" (click)="toggleFilterPanel()">×</button>
      </div>

      <!-- Source -->
      <div class="filter-section">
        <h3>Source</h3>
        <label>
          <input
            type="radio"
            name="source"
            value="inventory"
            [(ngModel)]="selectedSource"
            (ngModelChange)="toggleSource($event)" />
          Inventory only
        </label>
        <label>
          <input
            type="radio"
            name="source"
            value="donation"
            [(ngModel)]="selectedSource"
            (ngModelChange)="toggleSource($event)" />
          Donation List
        </label>
      </div>

      <!-- Category -->
      <div class="filter-section">
        <h3>Category</h3>

        <!-- All -->
        <label>
          <input
            type="checkbox"
            name="cat_all"
            [(ngModel)]="filter.categories.all"
            (ngModelChange)="onCategoryAllToggle($event)" />
          All
        </label>

        <!-- 动态分类 -->
        <label *ngFor="let cat of availableCategories">
        <input
          type="checkbox"
          name="cat_{{cat.key}}"
          [checked]="filter.categories[cat.key] === true"
          (change)="onCategoryChange(cat.key, $event.target.checked)" />
        {{ cat.name }}
      </label>



      </div>


      <!-- ✅ Expired in 只在 Inventory 模式下显示 -->
      <div class="filter-section" *ngIf="selectedSource === 'inventory'">
        <h3>Expired in</h3>

        <div class="expired-input-group">
          <input
            type="number"
            [(ngModel)]="filter.expiredIn"
            placeholder="Enter days"
            min="0" />
          <span>day(s)</span>
        </div>

        <!-- ✅ Apply 按钮单独放一行 -->
        <button class="apply-btn" (click)="applyExpiredFilter()">Apply</button>

        <!-- 🔹 Reset 按钮 -->
<button class="reset-btn" (click)="resetExpiredFilter()">Reset</button>
      </div>
    </div>
    <!-- ✅ Filter Drawer END -->

    <!-- 🔹 渲染 Storage → Category → Item -->
    <div *ngFor="let loc of viewLocs" class="location-block">
      <h1 *ngIf="selectedLocation === 'All'" class="location-title">{{ loc.name }}</h1>

      <div *ngFor="let category of loc.categories" class="category" [ngClass]="category.colorClass">
        <h2>{{ category.icon }} {{ category.name }}</h2>

        <!-- 每个食品项目 -->
        <div
          *ngFor="let item of category.items"
          class="item"
          (mouseenter)="hoverItem = item"
          (mouseleave)="hoverItem = null">

          <!-- 食物名称 -->
          <div class="item-name">{{ item.name }}</div>

          <!-- ✅ Donation List 模式 -->
          <div *ngIf="selectedSource === 'donation'; else normalItem" class="donation-row">
            <div class="remaining-box donation-view">{{ item.remaining }}</div>
            <div class="edit-slot">
              <button class="edit-btn" (click)="openConfirm(item, 'edit')">Edit</button>
            </div>
          </div>

          <!-- ✅ Inventory 模式 -->
          <ng-template #normalItem>
            <!-- 剩余数量 -->
            <div class="remaining-box" [ngClass]="getExpiryClass(item)">
              {{ item.remaining }}
            </div>

            <!-- 剩余天数 -->
            <div class="days-inline" [ngClass]="getExpiryClass(item)">
              {{ getRemainingDays(item.expiry) <= 0 ? 'Expired' : getRemainingDays(item.expiry) + ' days left' }}
            </div>

            <!-- 数量控制器 -->
            <div class="quantity-control">
              <button type="button" (click)="decreaseSelected(item)">-</button>
              <span class="qty">{{ item.selectedQty }}</span>
              <button type="button" (click)="increaseSelected(item)">+</button>
            </div>

            <!-- 操作按钮 -->
            <div class="hover-actions" [class.visible]="hoverItem === item">
              <button class="used" (click)="openConfirm(item, 'used')">Used</button>
              <button class="meal" (click)="openConfirm(item, 'meal')">Meal</button>
              <button class="donate" (click)="openConfirm(item, 'donate')">Donate</button>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 确认弹窗 -->
<div
  class="modal-overlay"
  *ngIf="showConfirm && confirmAction"
  (click)="closeConfirm()">

  <div
    class="modal"
    [ngClass]="{
      'modal-used': confirmAction === 'used',
      'modal-meal': confirmAction === 'meal',
      'modal-donate': confirmAction === 'donate',
      'modal-edit': confirmAction === 'edit'
    }"

    (click)="$event.stopPropagation()">

    <h2>
    <ng-container [ngSwitch]="confirmAction">
      <ng-container *ngSwitchCase="'edit'">
        Edit donation item of <strong>{{ confirmItem?.name }}</strong>?
      </ng-container>
      <ng-container *ngSwitchDefault>
        Do you want to mark {{ confirmItem?.selectedQty }}
        {{ confirmItem?.name }}(s) as {{ confirmAction }}?
      </ng-container>
    </ng-container>
  </h2>


    <div class="modal-buttons">
      <button class="cancel-btn" (click)="closeConfirm()">Cancel</button>
      <button
  class="action-btn"
  [ngClass]="{
    'btn-used': confirmAction === 'used',
    'btn-meal': confirmAction === 'meal',
    'btn-donate': confirmAction === 'donate',
    'btn-edit': confirmAction === 'edit'
  }"
  (click)="confirmActionProceed()">
  {{ confirmAction === 'edit' ? 'Edit' : (confirmAction | titlecase) }}
</button>

    </div>
  </div>
</div>
